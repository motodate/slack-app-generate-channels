
## テストリストの作成

まず、要件を機能単位やロジック単位に分解し、それぞれに対して「何をインプットしたら」「どういう状態になり」「何をアウトプットするのか」を検証するテスト項目を日本語で書き出していきます。

### 1. ドメインロジックのテスト（最も内側のロジックから）

最初に、Slack APIなどの外部依存から完全に切り離せる、純粋なビジネスロジックのテストを洗い出します。これらは最も高速に、かつ安定して実行できるテストです。

#### **チャンネル名の正規化 (ChannelNameNormalizer)**

- `[x]` **正常系:** 英小文字、数字、ハイフン、アンダースコアのみの有効なチャンネル名は、そのまま返される (`"my-channel_123"` -> `"my-channel_123"`)
    
- `[x]` **変換系:** 全角の英数字は半角に変換される (`"ｃｈａｎｎｅｌ-０１"` -> `"channel-01"`)
    
- `[x]` **変換系:** 大文字は小文字に変換される (`"My-Channel"` -> `"my-channel"`)
    
- `[x]` **変換系:** 1つ以上の空白は1つのハイフンに変換される (`"my new channel"` -> `"my-new-channel"`)
    
- `[x]` **除去系:** 許可されていない文字（例: `!@#$%^&*()`）は除去される (`"my_channel@!"` -> `"my_channel"`)
    
- `[x]` **文字数制限:** 80文字を超える場合は`ValueError`例外を発生させる
    

#### **メールアドレスの解析 (EmailAddressParser)**

- `[x]` **正常系:** カンマ区切り、改行区切り、またはその両方が混在した文字列から、メールアドレスのリストを正しく抽出できる
    
- `[x]` **正規化:** 各メールアドレスの前後の空白はトリミングされる (`" user@example.com "` -> `"user@example.com"`)
    
- `[x]` **正規化:** メールアドレス内の大文字は小文字に統一される (`"User@Example.com"` -> `"user@example.com"`)
    
- `[x]` **一意性:** 重複したメールアドレスは1つにまとめられる
    
- `[x]` **堅牢性:** 空の行や余分な区切り文字は無視され、リストに含まれない
    

---

### 2. アプリケーションロジックのテスト（外部連携を含む）

次に、Slack APIとの連携など、少し関心事が広がる部分のテストを洗い出します。これらは実際のAPIを叩くのではなく、APIクライアントをモック（スタブ）に差し替えてテストします。

#### **Slackユーザーの解決 (UserResolver)**

- `[x]` **正常系:** 存在するメールアドレスのリストを渡すと、SlackユーザーIDのリストと「見つからなかったメールアドレス」の空リストが返ってくる
    
- `[x]` **一部不在:** 存在しないメールアドレスが含まれている場合、見つかったユーザーIDのリストと、見つからなかったメールアドレスのリストが正しく返ってくる
    
- `[x]` **全員不在:** 渡されたメールアドレスがすべて存在しない場合、「全員が見つからなかった」ことを示す特別な状態（例: 例外）が返ってくる
    
- `[x]` **退会済み:** 退会・無効化されたユーザーのメールアドレスは、「見つからなかったメールアドレス」として扱われる
    

---

### 3. UI/インタラクションのテスト（Boltフレームワークレベル）

最後に、ユーザーの操作（ショートカット起動、ボタンクリックなど）を起点とした一連の振る舞いをテストします。`slack-bolt`にはテストを支援する機能があるので、それらを活用します。

#### **モーダル操作フロー**

- `[ ]` **起動:** ショートカットが実行されると、初期のチャンネル作成モーダルが正しく表示される
    
- `[ ]` **入力→確認:** ユーザーが情報を入力して「確認」ボタンを押すと、3秒以内に`ack()`が返り、非同期でユーザー解決処理がトリガーされる
    
- `[ ]` **確認モーダル表示 (正常系):** ユーザー解決後、招待可能なユーザーとチャンネル名を含む最終確認モーダルが表示される
    
- `[ ]` **確認モーダル表示 (不在ユーザーあり):** ユーザー解決後、「不在のメールアドレス一覧」を含む最終確認モーダルが表示される
    
- `[ ]` **作成→実行:** 「作成」ボタンを押すと、3秒以内に`ack()`が返り、モーダルが「作成中...」という表示に更新され、非同期でチャンネル作成処理がトリガーされる
    
- `[ ]` **成功:** チャンネル作成と招待が成功すると、モーダルが閉じられ、ユーザーに完了通知DMが送信される
    
- `[ ]` **失敗 (チャンネル名重複):** `conversations.create`が`name_taken`エラーを返した場合、モーダルが「このチャンネル名は既に使用されています」というエラー表示に更新される
    
- `[ ]` **失敗 (権限不足):** API呼び出しで権限不足エラーが発生した場合、ユーザーにその旨を伝えるDMが送信される
    
